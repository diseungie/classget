{% extends 'layout.html' %}

{% block stylesheet %}
<!-- ここにCSSファイルをリンクする -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/classinfo.css') }}" type="text/css">
{% endblock %}


{% block contents %}
<!-- ここから授業詳細 -->
  <fieldset class="outer">
    <div class="classinfo">
        <div class="box">
<!--      授業名      -->
            <div class="main-info">
                <h1 class="name">{{ subject.name }}</h1>
    <!--   学期と曜日・時限   -->
                <div class="term-and-time"><h3>{{ subject.term}} {{ subject.time }}</h3></div>
            </div>
<!--  お気に入りボタン    -->
            <div class="like_buttons{{ subject.id }}">
<!--       お気に入り済みの状態         -->
                {% if current_user.is_authenticated and current_user.has_liked_subject(subject) %}
                    <a href="" class="user_like_button" id="unlike_{{ subject.id }}">
                        <img class="like-button-img" src="{{ url_for('static', filename='img/liked.png') }}" width="35px">
                    </a>
<!--       お気に入りしてない状態        -->
                {% elif current_user.is_authenticated %}
                    <a href="" class="user_like_button" id="like_{{ subject.id }}">
                        <img class="like-button-img" src="{{ url_for('static', filename='img/unliked.png') }}" width="35px">
                    </a>
<!--       ログインしてない状態（押したらログインページに送る）      -->
                {% else %}
                    <a href="{{ url_for('login') }}" class="like_button">
                        <img class="like-button-img" src="{{ url_for('static', filename='img/unliked.png') }}" width="35px">
                    </a>
                {% endif %}
            </div>
        </div>
<!--　　授業情報　　-->
        <p class="sort">•{{ subject.sort }} <span class="draw">•{{ subject.draw }}</span></p>
        <p class="professor-and-language">•教員名：{{ subject.teacher }} 教授  <span class="draw">•言語：{{ subject.language }}</span></p>
<!--   ３段階の顔文字評価の集計   -->
        <div class="class-rating">
        <img class="face" src="{{ url_for('static', filename='img/rating_0.png') }}"> {{ get_count(Review.query.filter_by(subject_id=subject.id, rating=0)) }}
        <img class="face" src="{{ url_for('static', filename='img/rating_1.png') }}"> {{ get_count(Review.query.filter_by(subject_id=subject.id, rating=1)) }}
        <img class="face" src="{{ url_for('static', filename='img/rating_2.png') }}"> {{ get_count(Review.query.filter_by(subject_id=subject.id, rating=2)) }}
            <span class="liked_number">(お気に入り {{ get_count(subject.likes) }}件)</span>
        </div>
<!--    キーワード      -->
        <div class="keywords">
        {% for keyword in subject_keyword %}
          <span class="keyword">{{ keyword }}</span>
        {% endfor %}
        </div>
<!--    授業情報修正申請ボタン    -->
        <div class="report">
            <a href="{{ url_for('report', subject_id=subject.id) }}"><button class="report_button">この授業の最新情報報告</button></a>
        </div>
    </div>
<!--  授業情報修正ボタン（adminアカウントにだけ見える）  -->
    {% if current_user.is_authenticated and current_user.iduser == 'admin' %}
        <a href="{{ url_for('updateclass', subject_id=subject.id) }}"><button class="update_class_button">授業情報修正</button></a>
    {% endif %}
  </fieldset>

<!-- ここからレビュー一覧 -->
  <fieldset class="outer">
    <div class="reviews">過去のレビュー</div>
    {% if reviews.items %}
      {% for review in reviews.items %}
        <fieldset class="inner">
<!--　　　　レビュー作成者　　　　　-->
            <div class="author">
<!--      作成者アイコン       -->
              <img class="user-icon" src="{{ url_for('static', filename='img/profile_pics/{}.png'.format(review.author.type)) }}">
<!--      作成者のユーザー名       -->
              <div class="user-username">{{ review.author.username }}</div>
<!--      作成者の学部       -->
              <div class="user-faculty">{{ review.author.faculty }}</div>
            </div>
<!--　　　　レビュー内容　　　　　　-->
            <div class="review-body">
<!--      タイトル         -->
              <span class="review-title">{{ review.title }}</span>
<!--       評価     -->
              <img class="review_face" src="{{ url_for('static', filename='img/rating_{}.png'.format(review.rating)) }}">
<!--       投稿日付         -->
              <div class="uploaded_date">
                {{ review.date_posted.strftime('%Y-%m-%d') }}
              </div>
              <hr>
<!--       本文       -->
              <div class="review-content">{{ review.content }}</div>
<!--       キーワード         -->
              <div class="review-keywords">
                {% for keyword in review.keyword.split(" ") %}
                  <span class="keyword">{{ keyword }}</span>
                {% endfor %}
              </div>
<!--       レビュー削除ボタン（ログインしてるユーザー　＝＝　投稿者の場合）         -->
              {% if review.author == current_user %}
                <form class="delete-button" action="{{ url_for('delete_review', review_id=review.id, subject_id=subject.id) }}">
                  <button class="review-delete" type="submit">このレビューを削除</button>
                </form>
              {% endif %}
            </div>
        </fieldset>
      {% endfor %}
<!--   レビューがないとき   -->
    {% else %}
      <div>作成されたレビューがありません。</div>
    {% endif %}
<!--   ページの表示   -->
    <div class="page_nums">
        {% for page_num in reviews.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if page_num %}
                {% if reviews.page == page_num %}
                    <a class="current_page_num" href="{{ url_for('classinfo', subject_id=subject.id, page=page_num) }}">{{ page_num }}</a>
                {% else %}
                    <a class="page_num" href="{{ url_for('classinfo', subject_id=subject.id, page=page_num) }}">{{ page_num }}</a>
                {% endif %}
            {% else %}
                ...
            {% endif %}
        {% endfor %}
    </div>
  </fieldset>

  <!-- ここからレビュー作成 -->
    <fieldset class="outer">
      <div class="newreview">
        <div class="create-review"><h2>レビュー作成</h2></div><hr>
          <form method="POST" action="" class="newreview">
            {{ form.hidden_tag() }}
              <div class="title-review">
                {{ form.title.label(class="label-title") }}
                {{ form.title(class="blank-title", placeholder="15字以内") }}
              </div>

              <div class="rating-review">
                {{ form.rating.label(class="label-rating") }}
                {% for l, i in enumerate(form.rating) %}
                  <img class="face" src="{{ url_for('static', filename='img/rating_{}.png'.format(l)) }}"> {{ i(class="button") }}
                {% endfor %}
              </div>

              <div class="content-review">
                {{ form.content.label(class="label-content") }}
                {{ form.content(class="blank-content") }}
              </div>

              <div class="keyword-review">
                {{ form.keyword.label(class="label-keyword") }}
                <div class="select-keyword">
                    {{ form.keyword(class="blank-keyword") }}
                </div>
              </div>

              <div class="submit-review">
                {{ form.submit }}
              </div>
          </form>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='js/like_button.js') }}"></script>
      </div>
    </fieldset>
{% endblock %}